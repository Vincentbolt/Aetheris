<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Aetheris Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      font-family: 'Poppins', sans-serif;
      color: #f5f5f5;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(0, 224, 255, 0.08), transparent);
      border-radius: 50%;
      top: -300px;
      right: -300px;
      animation: float 15s ease-in-out infinite;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(0, 119, 255, 0.06), transparent);
      border-radius: 50%;
      bottom: -250px;
      left: -250px;
      animation: float 12s ease-in-out infinite reverse;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, 30px) scale(1.05); }
    }

    .navbar {
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 224, 255, 0.1);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .navbar-brand {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(90deg, #00e0ff, #0077ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
    }

    .nav-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-settings {
      background: rgba(0, 224, 255, 0.1);
      border: 1px solid rgba(0, 224, 255, 0.3);
      color: #00e0ff;
      border-radius: 12px;
      padding: 8px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-settings:hover {
      background: rgba(0, 224, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 224, 255, 0.2);
    }

    #logoutBtn {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid rgba(255, 68, 68, 0.3);
      color: #ff4444;
      border-radius: 12px;
      padding: 8px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #logoutBtn:hover {
      background: #ff4444;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(255, 68, 68, 0.3);
    }

    main {
      position: relative;
      z-index: 1;
      padding: 2rem 1rem;
    }

    .glass-card {
      background: rgba(20, 20, 30, 0.75);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00e0ff, #0077ff);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .glass-card:hover::before {
      opacity: 1;
    }

    .glass-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 70px rgba(0, 224, 255, 0.15);
      border-color: rgba(0, 224, 255, 0.2);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, #00e0ff, #0077ff);
      border-radius: 2px;
    }

    #hello {
      font-weight: 700;
      font-size: 2rem;
      background: linear-gradient(90deg, #00e0ff, #0077ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    #capital {
      font-size: 1.1rem;
      color: #aaa;
      font-weight: 400;
      margin-bottom: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 25px 0;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(0, 224, 255, 0.2);
      box-shadow: 0 10px 30px rgba(0, 224, 255, 0.1);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #888;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.2;
    }

    .stat-change {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    #marketStatus {
      text-align: center;
      color: #ff4444;
      font-weight: 600;
      font-size: 1rem;
      padding: 12px;
      background: rgba(255, 68, 68, 0.1);
      border-radius: 12px;
      margin-top: 15px;
    }

    .form-group label {
      color: #aaa;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: #00e0ff;
      box-shadow: 0 0 0 3px rgba(0, 224, 255, 0.1);
      outline: none;
      color: #fff;
    }

    .form-control:disabled {
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.05);
      color: #555;
      cursor: not-allowed;
    }

    .form-control option {
      background: #1a1a2e;
      color: #fff;
    }

    .btn {
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-loading {
      pointer-events: none;
      position: relative;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-success-pulse {
      animation: successPulse 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px currentColor; }
      100% { transform: scale(1); }
    }

    .btn-primary {
      background: linear-gradient(135deg, #00e0ff, #0077ff);
      color: #fff;
      box-shadow: 0 4px 15px rgba(0, 224, 255, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0, 224, 255, 0.4);
      color: #fff;
    }

    .btn-success {
      background: linear-gradient(135deg, #00e07f, #00c853);
      color: #fff;
      box-shadow: 0 4px 15px rgba(0, 224, 127, 0.2);
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0, 224, 127, 0.4);
      color: #fff;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: #fff;
      box-shadow: 0 4px 15px rgba(255, 68, 68, 0.2);
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(255, 68, 68, 0.4);
      color: #fff;
    }

    .btn-block {
      width: 100%;
      margin-top: 10px;
    }

    #tradesList {
      max-height: calc(100% - 50px);
      overflow-y: auto;
      padding-right: 10px;
    }

    #tradesList::-webkit-scrollbar {
      width: 6px;
    }

    #tradesList::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    #tradesList::-webkit-scrollbar-thumb {
      background: rgba(0, 224, 255, 0.3);
      border-radius: 10px;
    }

    #tradesList::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 224, 255, 0.5);
    }

    .trade-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-left: 3px solid #00e0ff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .trade-item:hover {
      transform: translateX(8px);
      background: rgba(0, 224, 255, 0.08);
      border-left-color: #0077ff;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 10px;
    }

    .status-idle {
      background: rgba(255, 255, 255, 0.1);
      color: #aaa;
    }

    .status-active {
      background: rgba(0, 224, 127, 0.15);
      color: #00e07f;
    }

    .status-error {
      background: rgba(255, 68, 68, 0.15);
      color: #ff4444;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #888;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .info-value {
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 9998;
      display: none;
    }

    .modal-backdrop.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .settings-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(0, 224, 255, 0.2);
      border-radius: 24px;
      padding: 2.5rem;
      max-width: 550px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 30px 90px rgba(0, 224, 255, 0.3);
      display: none;
    }

    .settings-modal.show {
      display: block;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    .settings-modal::-webkit-scrollbar {
      width: 6px;
    }

    .settings-modal::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .settings-modal::-webkit-scrollbar-thumb {
      background: rgba(0, 224, 255, 0.3);
      border-radius: 10px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #00e0ff, #0077ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid rgba(255, 68, 68, 0.3);
      color: #ff4444;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.5rem;
      line-height: 1;
    }

    .modal-close:hover {
      background: #ff4444;
      color: #fff;
      transform: rotate(90deg);
    }

    .settings-section {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #00e0ff;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: '';
      width: 3px;
      height: 18px;
      background: #00e0ff;
      border-radius: 2px;
    }

    .password-input-wrapper {
      position: relative;
    }

    .password-toggle-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }

    .password-toggle-icon:hover {
      color: #00e0ff;
    }

    .saved-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #00e07f;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 10px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .saved-indicator.show {
      opacity: 1;
      transform: translateY(0);
      animation: checkBounce 0.6s ease;
    }

    @keyframes checkBounce {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-8px); }
      50% { transform: translateY(0); }
      75% { transform: translateY(-4px); }
    }

    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 224, 255, 0.3);
      border-radius: 16px;
      padding: 16px 24px;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      z-index: 10000;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      opacity: 0;
      transform: translateY(20px);
      animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .toast-notification.toast-hide {
      animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes toastSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toastSlideOut {
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .toast-success {
      border-color: rgba(0, 224, 127, 0.4);
      background: linear-gradient(135deg, rgba(0, 224, 127, 0.15), rgba(0, 200, 83, 0.1));
    }

    .toast-error {
      border-color: rgba(255, 68, 68, 0.4);
      background: linear-gradient(135deg, rgba(255, 68, 68, 0.15), rgba(204, 0, 0, 0.1));
    }

    .logout-msg {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4caf50;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .fadeIn {
      animation: fadeIn 0.8s ease-in forwards;
      opacity: 0;
    }

    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .col-lg-8, .col-lg-4, .col-md-7, .col-md-5 {
      animation: fadeIn 0.8s ease-in forwards;
      opacity: 0;
    }

    .col-lg-8, .col-md-7 {
      animation-delay: 0.1s;
    }

    .col-lg-4, .col-md-5 {
      animation-delay: 0.2s;
    }

    @media (max-width: 768px) {
      body::before,
      body::after {
        width: 400px;
        height: 400px;
      }

      .navbar {
        padding: 0.875rem 1rem;
        border-radius: 0 0 20px 20px;
      }

      .navbar-brand {
        font-size: 1.4rem;
        letter-spacing: 1.5px;
      }

      .nav-actions {
        gap: 6px;
      }

      .btn-settings {
        padding: 6px 12px;
        font-size: 0.75rem;
        border-radius: 10px;
      }

      .btn-settings svg {
        width: 14px;
        height: 14px;
      }

      #logoutBtn {
        padding: 6px 14px;
        font-size: 0.75rem;
        border-radius: 10px;
      }

      main {
        padding: 1rem 0.75rem;
      }

      .row {
        display: flex;
        flex-direction: column;
      }

      .col-lg-4 {
        order: 1;
        animation-delay: 0s !important;
      }

      .col-lg-8 {
        order: 2;
        animation-delay: 0.15s !important;
        margin-top: 1rem;
      }

      .glass-card {
        padding: 1.25rem;
        border-radius: 18px;
        margin-bottom: 1rem;
        animation: mobileSlideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        opacity: 0;
        transform: translateY(30px);
      }

      @keyframes mobileSlideUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .glass-card:hover {
        transform: translateY(-4px);
      }

      .glass-card:active {
        transform: scale(0.98);
      }

      #hello {
        font-size: 1.6rem;
        margin-bottom: 0.75rem;
      }

      #capital {
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin: 1.25rem 0;
      }

      .stat-card {
        padding: 1rem;
        border-radius: 14px;
        flex-direction: column;
        align-items: flex-start;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at center, rgba(0, 224, 255, 0.1), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .stat-card:active::before {
        opacity: 1;
      }

      .stat-card:active {
        transform: scale(0.96);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(0, 224, 255, 0.3);
        box-shadow: 0 8px 25px rgba(0, 224, 255, 0.15);
      }

      .stat-icon {
        width: 44px;
        height: 44px;
        margin-bottom: 8px;
        transition: transform 0.3s ease;
      }

      .stat-card:active .stat-icon {
        transform: scale(1.1) rotate(5deg);
      }

      .stat-icon svg {
        width: 22px;
        height: 22px;
      }

      .stat-info {
        width: 100%;
      }

      .stat-label {
        font-size: 0.75rem;
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 1.35rem;
        margin-bottom: 2px;
      }

      .stat-change {
        font-size: 0.7rem;
      }

      #marketStatus {
        font-size: 0.9rem;
        padding: 10px;
        margin-top: 12px;
        border-radius: 10px;
      }

      .glass-card[style*="height: 626px"] {
        height: 450px !important;
      }

      .card-title {
        font-size: 1.15rem;
        margin-bottom: 1rem;
      }

      .card-title::before {
        width: 3px;
        height: 20px;
      }

      #tradesList {
        padding-right: 8px;
      }

      .trade-item {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 10px;
        animation: tradeSlideIn 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .trade-item::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(0, 224, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.5s ease;
      }

      .trade-item:active::after {
        transform: translateX(100%);
      }

      @keyframes tradeSlideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .trade-item:active {
        transform: translateX(6px) scale(0.98);
        box-shadow: 0 6px 20px rgba(0, 224, 255, 0.2);
      }

      .form-group label {
        font-size: 0.85rem;
        margin-bottom: 6px;
      }

      .form-control {
        padding: 10px 14px;
        font-size: 0.9rem;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 224, 255, 0.15);
      }

      .btn {
        padding: 11px 20px;
        font-size: 0.9rem;
        border-radius: 10px;
        font-weight: 600;
        position: relative;
        overflow: hidden;
      }

      .btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn:active::after {
        width: 300px;
        height: 300px;
      }

      .btn:active {
        transform: scale(0.95);
      }

      .info-row {
        padding: 10px 0;
        transition: all 0.3s ease;
      }

      .info-row:active {
        background: rgba(0, 224, 255, 0.05);
        border-radius: 8px;
        padding-left: 8px;
        padding-right: 8px;
      }

      .info-label {
        font-size: 0.85rem;
      }

      .info-value {
        font-size: 0.95rem;
      }

      .status-badge {
        padding: 7px 14px;
        font-size: 0.8rem;
        border-radius: 18px;
        transition: all 0.3s ease;
      }

      .status-badge:active {
        transform: scale(1.05);
      }

      .status-indicator {
        width: 7px;
        height: 7px;
      }

      .settings-modal {
        padding: 2rem 1.5rem;
        width: 95%;
        max-height: 85vh;
        border-radius: 20px;
      }

      .modal-title {
        font-size: 1.35rem;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
        transition: all 0.3s ease;
      }

      .modal-close:active {
        transform: rotate(90deg) scale(0.9);
      }

      .section-title {
        font-size: 1rem;
      }

      .toast-notification {
        bottom: 20px;
        right: 20px;
        left: 20px;
        min-width: unset;
        padding: 14px 18px;
        font-size: 0.85rem;
        box-shadow: 0 10px 40px rgba(0, 224, 255, 0.3);
      }
    }

    @media (max-width: 576px) {
      .navbar-brand {
        font-size: 1.3rem;
        letter-spacing: 1.2px;
      }

      .glass-card {
        padding: 1.125rem;
        border-radius: 16px;
      }

      #hello {
        font-size: 1.4rem;
      }

      #capital {
        font-size: 0.9rem;
      }

      .stats-grid {
        gap: 0.65rem;
      }

      .stat-card {
        padding: 0.875rem;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
      }

      .stat-value {
        font-size: 1.25rem;
      }

      .card-title {
        font-size: 1.05rem;
      }

      .settings-modal {
        padding: 1.5rem 1rem;
        border-radius: 18px;
      }

      .modal-title {
        font-size: 1.25rem;
      }

      .form-control {
        font-size: 0.875rem;
      }

      .btn {
        font-size: 0.875rem;
        padding: 10px 18px;
      }
    }

    @media (max-width: 400px) {
      .navbar {
        padding: 0.75rem 0.875rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card {
        flex-direction: row;
        align-items: center;
        gap: 12px;
      }

      .stat-icon {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark d-flex justify-content-between align-items-center">
    <span class="navbar-brand">AETHERIS</span>
    <div class="nav-actions">
      <button id="settingsBtn" class="btn btn-settings">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
          <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
        </svg>
        API Settings
      </button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </nav>

  <!-- Settings Modal -->
  <div id="settingsBackdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="settings-modal">
    <div class="modal-header">
      <h3 class="modal-title">API Configuration</h3>
      <div class="modal-close" id="closeSettings">×</div>
    </div>

    <div class="settings-section">
      <div class="section-title">
        <span>Angel One Credentials</span>
        <span id="savedIndicator" class="saved-indicator">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
          </svg>
          Saved
        </span>
      </div>

      <div class="form-group">
        <label>API Key</label>
        <input type="text" id="apiKey" class="form-control" placeholder="Enter your API Key"/>
      </div>

      <div class="form-group">
        <label>Client ID</label>
        <input type="text" id="clientId" class="form-control" placeholder="Enter your Client ID"/>
      </div>

      <div class="form-group">
        <label>TOTP Key</label>
        <input type="text" id="totpKey" class="form-control" placeholder="Enter your TOTP Key"/>
      </div>

      <div class="form-group">
        <label>Password</label>
        <div class="password-input-wrapper">
          <input type="password" id="password" class="form-control" placeholder="Enter your password"/>
          <span class="password-toggle-icon" onclick="togglePasswordVisibility()">
            <svg id="eyeIcon" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
              <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
            </svg>
          </span>
        </div>
      </div>

      <button id="saveCredentialsBtn" class="btn btn-success btn-block">Save Credentials</button>
    </div>
  </div>

	<main class="container-fluid">
		<div class="row">
			<!-- Left: Bot Controls -->
			<div class="col-lg-4 col-md-5 mb-4">
				<div class="glass-card">
					<h5 class="card-title">Bot Controls</h5>
					<div class="form-group">
						<label>Variety</label> <select id="varietySelect"
							class="form-control" style="height: 50px;">
							<option value="ROBO">ROBO</option>
							<option value="NORMAL">NORMAL</option>
						</select>
					</div>
					<div class="form-group">
						<label>Expiry Date (ddMMMyyyy)</label> <input type="text"
							id="expiryDateInput" class="form-control" value="14OCT2025" />
					</div>
					<div class="form-group">
						<label>Index Type</label> <select id="indexType"
							class="form-control" style="height: 50px;">
							<option value="NIFTY">NIFTY</option>
							<option value="BANKNIFTY">BANKNIFTY</option>
							<option value="MIDCPNIFTY">MIDCPNIFTY</option>
							<option value="FINNIFTY">FINNIFTY</option>
							<option value="SENSEX">SENSEX</option>
						</select>
					</div>
					<div class="form-group">
						<label>Capital Amount (₹)</label> <input type="number"
							id="capitalAmount" class="form-control" value="500000" />
					</div>
					<div class="form-group">
						<label>Target %</label> <input type="number" id="targetPercent"
							class="form-control" value="2" />
					</div>
					<div class="form-group">
						<label>Stoploss %</label> <input type="number"
							id="stoplossPercent" class="form-control" value="1" />
					</div>

					<button id="saveConfigBtn" class="btn btn-success btn-block">Save
						Config</button>
					<button id="startBotBtn" class="btn btn-primary btn-block">Start
						Bot</button>
					<button id="stopBotBtn" class="btn btn-danger btn-block">Stop
						Bot</button>

					<div style="margin-top: 25px;">
						<div class="info-row">
							<span class="info-label">Status</span> <span id="positionStatus"
								class="status-badge status-idle"> <span
								class="status-indicator"></span> Idle
							</span>
						</div>
						<div class="info-row">
							<span class="info-label">Monitoring</span> <span
								id="monitorStatus" class="info-value">No</span>
						</div>
						<div class="info-row">
  							<span class="info-label" id="botStatusLabel">Status</span>
  							<span id="botStatusTime" class="info-value">-</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Right: Hello + Stats + Recent Trades -->
			<div class="col-lg-8 col-md-7 mb-4">
				<!-- Hello + Capital Warning -->
				<div class="glass-card mb-4">
					<h5 id="hello">Hello, Trader</h5>
					<p id="capital" style="color: #ffc107; font-weight: 500;">⚠️
						Please ensure sufficient capital is available in your Angel One
						account before placing trades.</p>

					<!-- Performance Stats Grid -->
					<div class="stats-grid">
						<div class="stat-card">
							<div class="stat-icon"
								style="background: rgba(0, 224, 127, 0.1);">
								<svg width="24" height="24" fill="#00e07f" viewBox="0 0 16 16">
                  					<path
										d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z" />
                				</svg>
							</div>
							<div class="stat-info">
								<div class="stat-label">Available Balance</div>
								<div class="stat-value">45000</div>
								<div class="stat-change">In Broker Account</div>
							</div>		
						</div>

						<div class="stat-card">
							<div class="stat-icon"
								style="background: rgba(0, 224, 255, 0.1);">
								<svg width="24" height="24" fill="#00e0ff" viewBox="0 0 16 16">
                  					<path
										d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z" />
                					</svg>
							</div>
							<div class="stat-info">
								<div class="stat-label">Total Trades</div>
								<div class="stat-value">247</div>
								<div class="stat-change">12 today</div>
							</div>
						</div>

						<div class="stat-card">
							<div class="stat-icon"
								style="background: rgba(255, 193, 7, 0.1);">
								<svg width="24" height="24" fill="#ffc107" viewBox="0 0 16 16">
                  					<path
										d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z" />
                					</svg>
							</div>
							<div class="stat-info">
								<div class="stat-label">Win Rate</div>
								<div class="stat-value">68.5%</div>
								<div class="stat-change">169/247 wins</div>
							</div>
						</div>

						<div class="stat-card">
							<div class="stat-icon"
								style="background: rgba(156, 39, 176, 0.1);">
								<svg width="24" height="24" fill="#9c27b0" viewBox="0 0 16 16">
                  					<path
										d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456z" />
                					</svg>
							</div>
							<div class="stat-info">
								<div class="stat-label">Today's P&L</div>
								<div class="stat-value" style="color: #00e07f;">+₹12,450</div>
								<div class="stat-change">+2.49%</div>
							</div>
						</div>
					</div>

					<div id="marketStatus"></div>
				</div>

				<!-- Recent Trades -->
				<div class="glass-card"
					style="height: 626px; display: flex; flex-direction: column;">
					<h5 class="card-title">Recent Trades</h5>
					<div id="tradesList" style="flex: 1 1 auto;">
						<!-- Trades dynamically loaded via JS -->
					</div>
				</div>
			</div>
		</div>
	</main>


	<script>
    // Toggle password visibility
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eyeIcon');

      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.innerHTML = '<path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/><path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/><path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>';
      } else {
        passwordInput.type = 'password';
        eyeIcon.innerHTML = '<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>';
      }
    }
    let botStartTime = null;
    let botTimerInterval = null;
    
    function formatElapsedTime(startTime) {
    	  const now = new Date();
    	  const elapsed = Math.floor((now - startTime) / 1000);

    	  const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
    	  const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
    	  const seconds = String(elapsed % 60).padStart(2, '0');

    	  return `${hours}:${minutes}:${seconds}`;
    	}

    function startLiveBotTimer() {
    	  botStartTime = new Date();
    	  clearInterval(botTimerInterval);

    	  document.getElementById('botStatusLabel').textContent = 'Running';
    	  botTimerInterval = setInterval(() => {
    	    document.getElementById('botStatusTime').textContent = formatElapsedTime(botStartTime);
    	  }, 1000);
    	}

    function getCurrentFormattedTime() {
    	  const now = new Date();
    	  return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded");
        const rawToken = localStorage.getItem("token");
        if (!rawToken) return;
        const jwtToken = rawToken.startsWith("Bearer ") ? rawToken.substring(7) : rawToken;

        fetch('/api/users/me', {
            headers: { 'Authorization': `Bearer ${jwtToken}` }
        })
        .then(res => res.json())
        .then(user => {
    	loadTodayTrades(user.id, jwtToken);
    	updateTradeStats(user.id, jwtToken);

    	setInterval(() => {
        loadTodayTrades(user.id, jwtToken);
        updateTradeStats(user.id, jwtToken);
    		}, 10000); 
		})
        .catch(err => console.error(err));
    });

    async function loadTodayTrades(userId, token) {
        if (!userId || !token) return;

        const response = await fetch(`/api/trade/today?userId=${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            console.error('Failed to load trades', response.status, response.statusText);
            return;
        }

        const trades = await response.json();
        const container = document.getElementById("tradesList");
        container.innerHTML = "";

        let totalPL = 0;
        let totalInvestment = 0;

        trades.forEach(trade => {
            const profitOrLoss = trade.exitPrice - trade.entryPrice;
            totalPL += profitOrLoss;
            totalInvestment += trade.entryPrice;

            const tradeHTML = `
                <div class="trade-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-weight: 600; color: #00e0ff;">${trade.indexOptionName}</span>
                        <span style="color: ${profitOrLoss >= 0 ? "#00e07f" : "#ff4444"}; font-weight: 600;">
                            ${profitOrLoss.toFixed(2)} (${trade.profitOrLossPercent.toFixed(2)}%)
                        </span>
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">
                        <span>Entry: ₹${trade.entryPrice}</span> | <span>Exit: ₹${trade.exitPrice}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        ${new Date(trade.entryTime).toLocaleTimeString()}
                    </div>
                </div>
            `;
            container.innerHTML += tradeHTML;
        });

     	// ✅ Update Today's P&L Card
        const plElement = document.querySelector(".stat-card:nth-child(4) .stat-value");
        const plPercentElement = document.querySelector(".stat-card:nth-child(4) .stat-change");

        if (plElement && plPercentElement) {
            plElement.textContent = `${totalPL >= 0 ? '+' : ''}₹${totalPL.toFixed(2)}`;
            const plPercent = totalInvestment > 0 ? (totalPL / totalInvestment) * 100 : 0;
            plPercentElement.textContent = `${plPercent >= 0 ? '+' : ''}${plPercent.toFixed(2)}%`;
        }
        if (totalPL >= 0) {
            plElement.style.color = "#00e07f";
            plPercentElement.style.color = "#00e07f";
        } else {
            plElement.style.color = "#ff4444";
            plPercentElement.style.color = "#ff4444";
        }
    }

    async function updateTradeStats(userId, token) {
        if (!userId || !token) return;

        const allResponse = await fetch(`/api/trade/all?userId=${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!allResponse.ok) return;
        const allTrades = await allResponse.json();
        const totalTradesCount = allTrades.length;

        const todayResponse = await fetch(`/api/trade/today?userId=${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!todayResponse.ok) return;
        const todayTrades = await todayResponse.json();
        const todayTradesCount = todayTrades.length;
        const availableCash = allTrades.length > 0 ? allTrades[0].availableCash : 0;
        const winningTradesCount = allTrades.filter(t => t.profitOrLossPercent > 0).length;
	
        const winRatePercent = totalTradesCount > 0 ? ((winningTradesCount / totalTradesCount) * 100).toFixed(1) : 0;

        const availableCashCard = document.querySelectorAll('.stat-info')[0];
        if (availableCashCard) {
        	availableCashCard.querySelector('.stat-value').textContent = availableCash;
        }
        
        const totalTradesCard = document.querySelectorAll('.stat-info')[1];
        if (totalTradesCard) {
            totalTradesCard.querySelector('.stat-value').textContent = totalTradesCount;
            totalTradesCard.querySelector('.stat-change').textContent = `${todayTradesCount} today`;
        }

        const winRateCard = document.querySelectorAll('.stat-info')[2];
        if (winRateCard) {
            winRateCard.querySelector('.stat-value').textContent = `${winRatePercent}%`;
            winRateCard.querySelector('.stat-change').textContent = `${winningTradesCount}/${totalTradesCount} wins`;
        }
    }

    
    document.addEventListener('DOMContentLoaded', () => {
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const settingsBackdrop = document.getElementById('settingsBackdrop');
      const closeSettings = document.getElementById('closeSettings');
      const saveCredentialsBtn = document.getElementById('saveCredentialsBtn');
      const savedIndicator = document.getElementById('savedIndicator');
      const logoutBtn = document.getElementById('logoutBtn');
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      const startBotBtn = document.getElementById('startBotBtn');
      const stopBotBtn = document.getElementById('stopBotBtn');
      const varietySelect = document.getElementById('varietySelect');
      const targetPercent = document.getElementById('targetPercent');
      const indexTypeSelect = document.getElementById('indexType');
      const stoplossPercent = document.getElementById('stoplossPercent');
      const positionStatus = document.getElementById('positionStatus');
      const monitorStatus = document.getElementById('monitorStatus');
      const cooldownEl = document.getElementById('cooldown');

      let cooldownTimer = null;
      let cooldownTime = 0;

      loadCredentials();

      settingsBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Settings button clicked!');
        settingsBackdrop.classList.add('show');
        settingsModal.classList.add('show');
        document.body.style.overflow = 'hidden';
      });

      const rawToken = localStorage.getItem('token');
      const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

      fetch('/api/users/me', {
          method: 'GET',
          headers: {
              'Authorization': `Bearer ${token}`
          }
      }).then(res => {
    	  if (!res.ok) throw new Error("Unable to fetch user");
    	  return res.json();
    	}).then(data => {
        document.getElementById("hello").textContent = `Hello, ${data.username}`;
      })
      .catch(err => {
        console.error("Error:", err);
        document.getElementById("hello").textContent = "Hello, Trader";
      });
      
      function toggleFields() {
    	    if (varietySelect.value === 'NORMAL') {
    	        targetPercent.disabled = true;
    	        stoplossPercent.disabled = true;
    	    } else {
    	        targetPercent.disabled = false;
    	        stoplossPercent.disabled = false;
    	    }
    	}

    	// Event listener for variety changes (for non-SENSEX)
    	varietySelect.addEventListener('change', toggleFields);

    	// Event listener for indexType changes
    	indexTypeSelect.addEventListener('change', () => {
    	    if (indexTypeSelect.value === 'SENSEX') {
    	        varietySelect.value = 'NORMAL';
    	        varietySelect.disabled = true; // disable selection
    	    } else {
    	        varietySelect.disabled = false; // enable selection
    	        varietySelect.value = 'ROBO';   // or leave previous config
    	    }
    	    toggleFields();
    	});

    	async function loadBotConfig() {
    	    const rawToken = localStorage.getItem('token');
    	    if (!rawToken) return;
    	    const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

    	    try {
    	        const response = await fetch('/api/bot-config/me', {
    	            method: 'GET',
    	            headers: {
    	                'Authorization': `Bearer ${token}`
    	            }
    	        });

    	        if (!response.ok) throw new Error('Failed to fetch bot config');

    	        const config = await response.json().catch(() => ({}));
    	        if (!config) return;

    	        // Set IndexType first
    	        indexTypeSelect.value = config.indexType || 'NIFTY';

    	        // Set variety and disable if index is SENSEX
    	        if (indexTypeSelect.value === 'SENSEX') {
    	            varietySelect.value = 'NORMAL';
    	            varietySelect.disabled = true;
    	        } else {
    	            varietySelect.value = config.variety || 'ROBO';
    	            varietySelect.disabled = false;
    	        }

    	        // Set other fields
    	        document.getElementById('expiryDateInput').value = config.expiryDate || '';
    	        document.getElementById('capitalAmount').value = config.capitalAmount || 500000;
    	        targetPercent.value = config.targetPercent || 2;
    	        stoplossPercent.value = config.stoplossPercent || 1;

    	        toggleFields(); // adjust target/stoploss based on variety
    	        console.log('Bot config loaded:', config);
    	    } catch (err) {
    	        console.error('Error loading bot config:', err);
    	    }
    	}

    	loadBotConfig();
        
    	function loadCredentials() {
       	const rawToken = localStorage.getItem('token');
       	if (!rawToken) return;

       	const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

       	fetch('/api/settings/me', {
           method: 'GET',
           headers: {
               'Authorization': `Bearer ${token}`
           }
        })
       .then(res => {
           if (!res.ok) throw new Error("Unable to fetch settings");
           return res.json();
        })
       .then(creds => {
           if (creds) {
               document.getElementById('apiKey').value = creds.apiKey || '';
               document.getElementById('clientId').value = creds.clientId || '';
               document.getElementById('totpKey').value = creds.totpKey || '';
               document.getElementById('password').value = creds.password || '';
           }
        })
        .catch(err => console.error("Error loading settings:", err));
        }
      
      function closeModal() {
        settingsModal.classList.remove('show');
        settingsBackdrop.classList.remove('show');
        document.body.style.overflow = 'auto';
      }

      closeSettings.addEventListener('click', closeModal);
      settingsBackdrop.addEventListener('click', closeModal);

      saveConfigBtn.addEventListener('click', async () => {
    		const config = {
        	variety: varietySelect.value,
        	expiryDate: document.getElementById('expiryDateInput').value,
        	indexType: document.getElementById('indexType').value,
        	capitalAmount: parseFloat(document.getElementById('capitalAmount').value),
        	targetPercent: parseFloat(targetPercent.value),
        	stoplossPercent: parseFloat(stoplossPercent.value)
    	};

    	const rawToken = localStorage.getItem('token');
    	if (!rawToken) {
        	showToast('⚠️ You are not logged in!', 'error');
        	return;
    	}
    	const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

        setButtonLoading(saveConfigBtn, true, 'Saving...');

    	try {
        	const response = await fetch('/api/bot-config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(config)
        });

        if (!response.ok) throw new Error('Failed to save bot config');

        const result = await response.json();
        console.log('Bot config saved:', result);

        sessionStorage.setItem('botConfig', JSON.stringify(config));

        await new Promise(resolve => setTimeout(resolve, 600));
        setButtonLoading(saveConfigBtn, false);
        buttonSuccessPulse(saveConfigBtn);
        showToast('Bot configuration saved!', 'success');

    	} catch (err) {
        	console.error('Error saving bot config:', err);
            setButtonLoading(saveConfigBtn, false);
        	showToast('❌ Error saving bot config!', 'error');
    	}
		});
   
      saveCredentialsBtn.addEventListener('click', async () => {
    	const credentials = {
        		apiKey: document.getElementById('apiKey').value,
        		clientId: document.getElementById('clientId').value,
        		totpKey: document.getElementById('totpKey').value,
        		password: document.getElementById('password').value
      };

      if (!credentials.apiKey || !credentials.clientId || !credentials.totpKey || !credentials.password) {
        showToast('⚠️ Please fill all credential fields', 'error');
        return;
      }

      setButtonLoading(saveCredentialsBtn, true, 'Saving...');

       try {
        const rawToken = localStorage.getItem('token');
		const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;
        const response = await fetch('/api/settings/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(credentials)
        });

        const result = await response.json();
        console.log('Server response:', result);

        await new Promise(resolve => setTimeout(resolve, 600));
        setButtonLoading(saveCredentialsBtn, false);
        buttonSuccessPulse(saveCredentialsBtn);

        savedIndicator.classList.add('show');
        setTimeout(() => savedIndicator.classList.remove('show'), 3000);
        
        showToast('✅ Credentials saved successfully!', 'success');
        } catch (err) {
        console.error('Error saving credentials:', err);
        setButtonLoading(saveCredentialsBtn, false);
        showToast('❌ Failed to save credentials. Try again.', 'error');
        }
     });

      logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('apiCredentials');

      const msgDiv = document.createElement('div');
      msgDiv.textContent = 'Logged out successfully';
      msgDiv.className = 'logout-msg';
      document.body.appendChild(msgDiv);

      setTimeout(() => msgDiv.remove(), 2000);
      setTimeout(() => window.location.href = '/login.html', 500);
      });

      startBotBtn.addEventListener('click', async () => {
    	    const rawToken = localStorage.getItem('token');
    	    if (!rawToken) {
    	        showToast('⚠️ Missing authentication token. Please log in.', 'error');
    	        settingsModal.classList.add('show');
    	        settingsBackdrop.classList.add('show');
    	        return;
    	    }

    	    const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

    	    try {
    	        const res = await fetch('/api/settings/me', {
    	            method: 'GET',
    	            headers: { 'Authorization': `Bearer ${token}` }
    	        });

    	        if (!res.ok) throw new Error("Failed to fetch credentials");

    	        const creds = await res.json();
    	        const hasAllCreds = creds.apiKey && creds.clientId && creds.totpKey && creds.password;

    	        if (!hasAllCreds) {
    	            showToast('⚠️ Please complete all required API credentials!', 'error');
    	            settingsModal.classList.add('show');
    	            settingsBackdrop.classList.add('show');
    	            return;
    	        }

    	        const userRes = await fetch('/api/users/me', {
    	            headers: { 'Authorization': `Bearer ${token}` }
    	        });
    	        if (!userRes.ok) throw new Error("Failed to fetch user info");
    	        const user = await userRes.json();

    	        // Show loading state
    	        setButtonLoading(startBotBtn, true, 'Starting...');

    	        const startRes = await fetch(`/api/bot/start?userId=${user.id}`, {
    	            method: 'POST',
    	            headers: { 'Authorization': `Bearer ${token}` }
    	        });

    	        if (!startRes.ok) {
    	            const errorText = await startRes.text();
    	            showToast(errorText, 'error'); // ⚠️ Bot is already running
    	            setButtonLoading(startBotBtn, false);
    	            return;
    	        }

    	        const resultText = await startRes.text();
    	        console.log("Bot start API response:", resultText);

    	        // ✅ Disable permanently until bot stops
    	        startBotBtn.disabled = true;
    	        startBotBtn.classList.remove('btn-loading'); // remove loading effect
    	        buttonSuccessPulse(startBotBtn);

    	        updateStatus('active');
    	        monitorStatus.textContent = 'Yes';

    	        botStartTime = new Date();
    	        startLiveBotTimer();

    	        showToast('🤖 Bot started successfully!', 'success');
    	        console.log('Bot started with config:', sessionStorage.getItem('botConfig'));

    	    } catch (err) {
    	        console.error("Error starting bot:", err);
    	        showToast('⚠️ Error starting bot. Please try again.', 'error');
    	        setButtonLoading(startBotBtn, false); // only needed if an error occurs
    	    }
    	});


      stopBotBtn.addEventListener('click', async () => {
    	    setButtonLoading(stopBotBtn, true, 'Stopping...');

    	    const rawToken = localStorage.getItem('token');
    	    if (!rawToken) {
    	        showToast('⚠️ Missing authentication token. Please log in.', 'error');
    	        settingsModal.classList.add('show');
    	        settingsBackdrop.classList.add('show');
    	        setButtonLoading(stopBotBtn, false);
    	        return;
    	    }

    	    const token = rawToken.startsWith('Bearer ') ? rawToken.substring(7) : rawToken;

    	    try {
    	        const res = await fetch('/api/bot/stop', {
    	            method: 'POST',
    	            headers: { 'Authorization': `Bearer ${token}` }
    	        });

    	        if (!res.ok) throw new Error("Failed to stop bot");
    	        console.log("Bot stop API response:", await res.text());

    	        await new Promise(resolve => setTimeout(resolve, 800));

    	        setButtonLoading(stopBotBtn, false);
    	        buttonSuccessPulse(stopBotBtn);

    	        updateStatus('idle');
    	        monitorStatus.textContent = 'No';

    	        if (botStartTime) {
    	            const elapsedMs = new Date() - botStartTime;
    	            const elapsedSeconds = Math.floor(elapsedMs / 1000);
    	            const hours = Math.floor(elapsedSeconds / 3600).toString().padStart(2, '0');
    	            const minutes = Math.floor((elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
    	            const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
    	            const elapsedTime = `${hours}:${minutes}:${seconds}`;
    	            document.getElementById('botStatusTime').textContent = elapsedTime;
    	        }

    	        clearInterval(botTimerInterval);
    	        botStartTime = null;
    	        document.getElementById('botStatusLabel').textContent = 'Stopped';

    	        // ✅ Re-enable Start button after stopping
    	        startBotBtn.disabled = false;
    	        startBotBtn.textContent = 'Start'; // reset text
    	        startBotBtn.classList.remove('btn-loading');
    	        buttonSuccessPulse(startBotBtn);
    	        
    	        showToast('🛑 Bot stopped successfully', 'success');
    	        console.log('Bot stopped');

    	    } catch (err) {
    	        console.error("Error stopping bot:", err);
    	        showToast('⚠️ Error stopping bot. Please try again.', 'error');
    	        setButtonLoading(stopBotBtn, false);
    	    }
    	});


      function updateStatus(status) {
        if (status === 'active') {
          positionStatus.className = 'status-badge status-active';
          positionStatus.innerHTML = `<span class="status-indicator"></span> Active`;
        } else {
          positionStatus.className = 'status-badge status-idle';
          positionStatus.innerHTML = `<span class="status-indicator"></span> Idle`;
        }
      }

      function setButtonLoading(button, isLoading, text = '') {
        if (isLoading) {
          button.dataset.originalText = button.textContent;
          button.textContent = text || button.textContent;
          button.classList.add('btn-loading');
          button.disabled = true;
        } else {
          button.textContent = button.dataset.originalText || button.textContent;
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      }

      function buttonSuccessPulse(button) {
        button.classList.add('btn-success-pulse');
        setTimeout(() => button.classList.remove('btn-success-pulse'), 600);
      }

      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        const icon = type === 'success' 
          ? '<svg class="toast-icon" fill="#00e07f" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>'
          : '<svg class="toast-icon" fill="#ff4444" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>';
        
        toast.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add('toast-hide');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    });
  </script>
</body>
</html>